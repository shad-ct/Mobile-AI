<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Chat</title>
    <!-- Link to our local CSS file -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Configuration Header -->
    <div class="config-header">
        <div class="input-group mr-4">
            <label for="ip-input">Ollama Host IP</label>
            <input type="text" id="ip-input" value="192.168.1.100"
                   placeholder="e.g., 192.168.1.100">
        </div>
        <div class="input-group">
            <label for="model-input">Model Name</label>
            <input type="text" id="model-input" value="qwen2.5-coder:0.5b"
                   placeholder="e.g., llama3">
        </div>
    </div>

    <!-- Chat Messages Display -->
    <div id="chat-container" class="chat-container">
        <div id="placeholder" class="placeholder">
            <span>
                Start a conversation by typing a message below.
            </span>
        </div>
    </div>

    <!-- Message Input Form -->
    <form id="chat-form" class="chat-form">
        <input type="text" id="message-input"
               placeholder="Type your message...">
        <button type="submit" id="send-button">
            Send
        </button>
    </form>

    <script>
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const ipInput = document.getElementById('ip-input');
        const modelInput = document.getElementById('model-input');
        const chatContainer = document.getElementById('chat-container');
        const sendButton = document.getElementById('send-button');
        const placeholder = document.getElementById('placeholder');
        let isLoading = false;

        const addMessage = (content, role) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = `message-bubble ${role}`;
            contentDiv.innerText = content;

            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll
        };

        const showTypingIndicator = () => {
            const indicatorDiv = document.createElement('div');
            indicatorDiv.id = 'typing-indicator';
            indicatorDiv.className = 'message model';
            indicatorDiv.innerHTML = `
                <div class="message-bubble model">
                    <div class="typing-indicator-dots">
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-pulse-fast"></div>
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-pulse-fast animation-delay-150"></div>
                        <div class="w-2 h-2 rounded-full bg-gray-400 animate-pulse-fast animation-delay-300"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(indicatorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        const hideTypingIndicator = () => {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        };

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message || isLoading) return;

            // Hide placeholder if it exists
            if (placeholder) {
                placeholder.classList.add('hidden');
            }

            isLoading = true;
            sendButton.disabled = true;
            messageInput.disabled = true;

            addMessage(message, 'user');
            messageInput.value = '';

            const ipAddress = ipInput.value;
            const modelName = modelInput.value;
            showTypingIndicator();

            try {
                const response = await fetch(`http://${ipAddress}:3001/api/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ipAddress: ipAddress,
                        modelName: modelName,
                        prompt: message
                    })
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                hideTypingIndicator();

                if (data.response) {
                    addMessage(data.response, 'model');
                } else if (data.error) {
                    addMessage(`Error: ${data.error}`, 'model');
                } else {
                    addMessage('An unexpected error occurred.', 'model');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                hideTypingIndicator();
                addMessage('An error occurred. Please check your Express server and network connection.', 'model');
            } finally {
                isLoading = false;
                sendButton.disabled = false;
                messageInput.disabled = false;
                messageInput.focus();
            }
        });

    </script>
</body>
</html>
